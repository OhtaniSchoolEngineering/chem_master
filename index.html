<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no">
    <title>共通テスト化学 完全攻略 - ChemMaster</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap"
        rel="stylesheet">

    <!-- MathJax Configuration -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgb(219, 228, 255) 90%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Glassmorphism Styles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .font-mono-num {
            font-family: 'Roboto Mono', monospace;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Mode Specifics */
        body.mode-immersive {
            overflow: hidden;
            /* Disable main scroll */
        }

        #examScrollContainer {
            -webkit-overflow-scrolling: touch;
            padding-bottom: 150px;
        }

        /* Card Flip Animation */
        .flip-container {
            perspective: 1000px;
            width: 100%;
            max-width: 36rem;
            transition: all 0.3s ease;
        }

        .flip-inner {
            position: relative;
            width: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
            display: grid;
            grid-template-columns: 1fr;
        }

        .flip-inner.flipped {
            transform: rotateY(180deg);
        }

        .flip-front,
        .flip-back {
            width: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 2rem;
            grid-row: 1;
            grid-column: 1;
        }

        .flip-back {
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
        }

        #quizLayer {
            z-index: 10;
            pointer-events: none;
            overflow-y: auto;
        }

        .flip-container {
            pointer-events: auto;
        }

        .drawing-cursor {
            cursor: crosshair;
        }

        /* Floating Toolbar */
        .floating-bar {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: auto;
            max-width: 98vw;
            white-space: nowrap;
            user-select: none;
            top: 1rem;
        }

        /* Answer Sheet Panel */
        #answerSheetPanel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(110%);
        }

        #answerSheetPanel.open {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            #answerSheetPanel {
                transform: translateY(110%);
                top: auto !important;
                bottom: 0;
                right: 0;
                left: 0;
                width: 100% !important;
                height: 50vh !important;
                border-radius: 24px 24px 0 0;
            }

            #answerSheetPanel.open {
                transform: translateY(0);
            }
        }

        .answer-btn-fixed {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 3000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Option Selection Styles */
        .quiz-option {
            transition: all 0.2s ease;
        }

        .quiz-option.selected {
            border-color: #6366f1;
            /* indigo-500 */
            background-color: #e0e7ff;
            /* indigo-100 */
            transform: translateX(4px);
        }

        .quiz-option.selected .option-badge {
            background-color: #6366f1;
            /* indigo-500 */
            color: white;
            border-color: #6366f1;
        }

        /* Checkbox Custom Style */
        .custom-checkbox input:checked+div {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }

        .custom-checkbox input:checked+div svg {
            display: block;
        }
    </style>
</head>

<body class="text-slate-800">

    <div id="app" class="w-full min-h-screen flex flex-col">

        <!-- Header (Home Only) -->
        <header id="mainHeader"
            class="flex justify-between items-center mb-4 glass-header px-4 py-2 rounded-b-xl md:rounded-2xl sticky top-2 z-40 transition-transform duration-300 mx-2 md:mx-auto max-w-6xl w-full">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="app.goHome()">
                <div
                    class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-2 rounded-lg shadow-md shadow-indigo-200 group-hover:shadow-indigo-300 transition-all duration-300">
                    <i class="ph ph-flask text-lg"></i>
                </div>
                <div>
                    <h1
                        class="font-bold text-lg tracking-tight text-slate-800 group-hover:text-indigo-600 transition-colors leading-tight">
                        ChemMaster</h1>
                    <p class="text-[9px] uppercase tracking-wider font-bold text-slate-400 leading-none">Exam Prep</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="app.goHome()"
                    class="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-100 transition-colors">
                    <i class="ph ph-house text-base"></i> Home
                </button>
                <button onclick="app.goMyPage()"
                    class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold text-white bg-slate-800 hover:bg-slate-700 shadow-sm transition-colors">
                    <i class="ph ph-user text-base"></i> My Page
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="mainContainer" class="flex-grow container mx-auto px-2 py-2 max-w-6xl transition-all duration-300">
            <!-- Dynamic Content -->
        </main>

        <!-- Footer (Home Only) -->
        <footer id="mainFooter" class="mt-8 text-center py-4 mx-auto max-w-6xl w-full">
            <p class="text-[10px] text-slate-400 font-medium">&copy; 2024 ChemMaster. Designed for Students.</p>
        </footer>

    </div>

    <!-- Answer Sheet Panel (Exam Mode) -->
    <div id="answerSheetPanel"
        class="fixed top-24 bottom-6 right-6 w-96 bg-white/95 backdrop-blur-md shadow-2xl z-[3500] rounded-3xl border border-slate-200/50 flex flex-col overflow-hidden pointer-events-auto">
        <div
            class="p-4 border-b border-slate-100 flex justify-between items-center bg-indigo-50/80 backdrop-blur-sm sticky top-0 z-10">
            <div>
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="ph ph-clipboard-text text-indigo-600"></i> 解答用紙
                </h3>
                <p class="text-[10px] text-slate-500 mt-0.5" id="answerSheetMeta">全20問</p>
            </div>
            <button onclick="app.toggleAnswerSheet()"
                class="w-8 h-8 flex items-center justify-center hover:bg-slate-200/50 rounded-full text-slate-500 transition-colors">
                <i class="ph ph-caret-down text-lg md:hidden"></i>
                <i class="ph ph-caret-right text-lg hidden md:block"></i>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto p-4 custom-scrollbar bg-slate-50/50" id="answerSheetForm"></div>
        <div class="p-4 border-t border-slate-200 bg-white/80 backdrop-blur-sm sticky bottom-0 z-10">
            <button onclick="app.submitMockExamConfirm()"
                class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 active:scale-95">
                <i class="ph ph-paper-plane-tilt text-lg"></i> 採点する
            </button>
        </div>
    </div>

    <!-- General Modals -->
    <div id="customModal"
        class="fixed inset-0 bg-black/40 z-[4000] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0"
        aria-hidden="true">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-95 opacity-0"
            id="modalContent">
            <div class="flex items-center gap-3 mb-4 text-slate-800">
                <div id="modalIcon" class="text-2xl text-rose-500"><i class="ph ph-warning-circle"></i></div>
                <h3 id="modalTitle" class="font-bold text-lg">確認</h3>
            </div>
            <p id="modalMessage" class="text-slate-600 mb-6 text-sm leading-relaxed"></p>
            <div class="flex justify-end gap-3">
                <button onclick="app.closeModal()"
                    class="px-4 py-2 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors">キャンセル</button>
                <button id="modalConfirmBtn"
                    class="px-4 py-2 rounded-xl font-bold text-white bg-rose-600 hover:bg-rose-700 shadow-lg transition-transform hover:scale-105 active:scale-95">実行</button>
            </div>
        </div>
    </div>

    <!-- Dictionary Detail Modal -->
    <div id="dictModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[3800] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0"
        onclick="if(event.target===this) app.closeDictModal()">
        <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh] transform transition-all scale-95 opacity-0"
            id="dictModalContent">
            <!-- Content Injected Here -->
        </div>
    </div>

    <div id="customToast"
        class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl transform -translate-y-20 opacity-0 transition-all duration-300 z-[4500] font-bold text-sm flex items-center gap-2 pointer-events-none">
        <i class="ph ph-check-circle text-green-400 text-lg"></i>
        <span id="toastMessage">Success</span>
    </div>

    <!-- ========================================== -->
    <!-- DATA LOADING SECTION -->
    <!-- ========================================== -->
    <script>
        // Initialize Global Question Pool
        window.questionPool = [];
    </script>

    <!-- Load Unit Data Files -->
    <script src="unit_A.js"></script>
    <script src="unit_B.js"></script>
    <script src="unit_C.js"></script>
    <script src="unit_D.js"></script>
    <script src="unit_E.js"></script>
    <script src="unit_F.js"></script>

    <script>
        // ==========================================
        // APP LOGIC
        // ==========================================

        const app = {
            state: {
                currentScreen: 'home',
                selectedUnit: null,
                selectedLevel: null,
                quizList: [], // Will contain questions with generated options
                answers: [],
                timerInterval: null,
                startTime: 0,
                questionStartTime: 0,
                history: JSON.parse(localStorage.getItem('chemMaster_history')) || {},
                mistakes: JSON.parse(localStorage.getItem('chemMaster_mistakes')) || [],
                dictFilter: { unit: 'ALL', level: 'ALL', status: 'ALL', search: '' },
                quizFilter: { all: true, clear: false, winning: false, revenge: false, unanswered: false }, // New Filter State
                dictViewMode: 'grid',
                mode: 'normal',
                fromScreen: 'home',
                mockAnswers: {},
                penColor: '#333333',
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                canvasContext: null,
                scale: 1.0,
                minScale: 0.5,
                maxScale: 3.0,
                initialPinchDistance: null,
                initialScale: 1.0,
                resizeObserver: null,
                isAnswerSheetOpen: false,
                currentQuizIndex: 0,
                quizFeedback: null,
                cardAlignment: 'center',
                selectedOptionIndex: null,
                examTimeLimit: 60, // Default 60 mins
                selectedUnitName: ''
            },

            // Constants
            unitMap: { 'A': '化学基礎', 'B': '状態理論', 'C': '反応理論', 'D': '無機化学', 'E': '有機化学', 'F': '高分子' },
            levelMap: { 1: '知識', 2: '思考', 3: '応用', 4: '本番' },

            // Helper for colors
            getUnitColor: (id) => {
                const colors = {
                    'A': 'bg-blue-100 text-blue-700',
                    'B': 'bg-cyan-100 text-cyan-700',
                    'C': 'bg-teal-100 text-teal-700',
                    'D': 'bg-yellow-100 text-yellow-700',
                    'E': 'bg-orange-100 text-orange-700',
                    'F': 'bg-red-100 text-red-700'
                };
                return colors[id] || 'bg-slate-100 text-slate-700';
            },

            getLevelColor: (id) => {
                const colors = {
                    1: 'bg-indigo-50 text-indigo-700',
                    2: 'bg-purple-50 text-purple-700',
                    3: 'bg-rose-50 text-rose-700',
                    4: 'bg-slate-800 text-white'
                };
                return colors[id] || 'bg-slate-100 text-slate-700';
            },

            init: () => {
                // app.enrichData(); // データを自動コピーする機能を無効化しました
                app.renderHome();
                setTimeout(() => { if (window.MathJax) MathJax.typesetPromise(); }, 100);
            },

            // Data Enrichment (Disabled)
            enrichData: () => {
                // ...
            },

            // --- Navigation ---
            goHome: () => { app.cleanup(); app.state.fromScreen = 'home'; app.state.currentScreen = 'home'; app.renderHome(); },
            goMyPage: () => { app.cleanup(); app.state.fromScreen = 'home'; app.state.currentScreen = 'mypage'; app.renderMyPage(); },
            goDictionary: () => {
                app.cleanup();
                app.state.currentScreen = 'dictionary';
                document.getElementById('mainHeader').classList.add('hidden');
                document.getElementById('mainFooter').classList.add('hidden');
                app.renderDictionary();
            },
            handleCloseButton: () => { if (app.state.fromScreen === 'dictionary') { app.goDictionary(); } else { app.goHome(); } },

            cleanup: () => {
                app.stopTimer();
                if (app.state.resizeObserver) { app.state.resizeObserver.disconnect(); app.state.resizeObserver = null; }
                document.body.classList.remove('mode-immersive');
                document.getElementById('mainHeader').classList.remove('hidden');
                document.getElementById('mainFooter').classList.remove('hidden');
                document.body.style.background = '';
                document.removeEventListener('keydown', app.handleQuizKeydown);
                const c = document.getElementById('mainContainer');
                c.className = 'flex-grow container mx-auto px-4 py-2 max-w-6xl transition-all duration-300';
                c.style.width = ''; c.style.height = ''; c.style.overflow = '';
                if (app.state.isAnswerSheetOpen) app.toggleAnswerSheet();
                app.closeDictModal();
            },

            // --- UI Helpers ---
            showToast: (msg) => { const t = document.getElementById('customToast'); document.getElementById('toastMessage').innerText = msg; t.classList.remove('translate-y-20', 'opacity-0'); t.classList.add('translate-y-0', 'opacity-100'); setTimeout(() => { t.classList.remove('translate-y-0', 'opacity-100'); t.classList.add('-translate-y-20', 'opacity-0'); }, 3000); },
            confirm: (message, callback) => { const m = document.getElementById('customModal'); document.getElementById('modalMessage').innerText = message; m.classList.remove('hidden'); requestAnimationFrame(() => { m.classList.remove('opacity-0'); document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0'); document.getElementById('modalContent').classList.add('scale-100', 'opacity-100'); }); document.getElementById('modalConfirmBtn').onclick = () => { app.closeModal(); if (callback) callback(); }; },
            showAlert: (message) => { const m = document.getElementById('customModal'); const btn = document.getElementById('modalConfirmBtn'); document.getElementById('modalMessage').innerText = message; btn.innerText = "OK"; m.classList.remove('hidden'); requestAnimationFrame(() => { m.classList.remove('opacity-0'); document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0'); document.getElementById('modalContent').classList.add('scale-100', 'opacity-100'); }); btn.onclick = () => { app.closeModal(); setTimeout(() => { btn.innerText = "実行"; }, 300); }; },
            closeModal: () => { const m = document.getElementById('customModal'); m.classList.add('opacity-0'); document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100'); document.getElementById('modalContent').classList.add('scale-95', 'opacity-0'); setTimeout(() => { m.classList.add('hidden'); }, 300); },

            // --- Stats & History ---
            getHistoryStats: () => {
                const keys = Object.keys(app.state.history);
                if (keys.length === 0) return { total: 0, rate: 0 };
                let totalAttempts = 0; let totalCorrect = 0;
                keys.forEach(k => { totalAttempts += app.state.history[k].attempts; totalCorrect += app.state.history[k].correct; });
                return { total: totalAttempts, rate: totalAttempts === 0 ? 0 : Math.round((totalCorrect / totalAttempts) * 100) };
            },
            saveQuestionHistory: (qId, isCorrect, timeTaken) => {
                if (!app.state.history[qId]) app.state.history[qId] = { correct: 0, wrong: 0, attempts: 0, totalTime: 0, streak: 0 };
                const h = app.state.history[qId];
                h.attempts++;
                if (isCorrect) { h.correct++; h.streak = (h.streak > 0) ? h.streak + 1 : 1; }
                else { h.wrong = (h.wrong || 0) + 1; h.streak = (h.streak < 0) ? h.streak - 1 : -1; }
                h.totalTime += timeTaken;
                localStorage.setItem('chemMaster_history', JSON.stringify(app.state.history));
            },
            startTimer: () => {
                if (!app.state.startTime) app.state.startTime = Date.now();
                if (!app.state.questionStartTime) app.state.questionStartTime = Date.now();
                if (app.state.timerInterval) clearInterval(app.state.timerInterval);
                app.state.timerInterval = setInterval(() => {
                    const now = Date.now();
                    let diff;
                    let displayTime = "";

                    if (app.state.currentScreen === 'quiz') {
                        diff = Math.floor((now - app.state.questionStartTime) / 1000);
                        const m = Math.floor(diff / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        displayTime = `${m}:${s}`;
                    } else if (app.state.currentScreen === 'exam') {
                        // Countdown Logic
                        const elapsed = Math.floor((now - app.state.startTime) / 1000);
                        let remaining = (app.state.examTimeLimit * 60) - elapsed;
                        if (remaining < 0) remaining = 0;

                        const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                        const s = (remaining % 60).toString().padStart(2, '0');
                        displayTime = `${m}:${s}`;

                        // Optional: Auto-finish if 0? For now just stay at 00:00.
                    } else {
                        diff = Math.floor((now - app.state.startTime) / 1000);
                        const m = Math.floor(diff / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        displayTime = `${m}:${s}`;
                    }

                    const timerEl = document.getElementById('timerDisplay');
                    if (timerEl) timerEl.innerText = displayTime;
                }, 1000);
            },
            stopTimer: () => { clearInterval(app.state.timerInterval); },

            // --- Renderers ---
            renderHome: () => {
                const units = [
                    { id: 'A', name: '化学基礎', color: 'from-blue-400 to-blue-600', icon: 'ph-atom' },
                    { id: 'B', name: '状態理論', color: 'from-cyan-400 to-cyan-600', icon: 'ph-thermometer' },
                    { id: 'C', name: '反応理論', color: 'from-teal-400 to-teal-600', icon: 'ph-arrows-left-right' },
                    { id: 'D', name: '無機化学', color: 'from-yellow-400 to-yellow-600', icon: 'ph-flask' },
                    { id: 'E', name: '有機化学', color: 'from-orange-400 to-orange-600', icon: 'ph-hexagon' },
                    { id: 'F', name: '高分子', color: 'from-red-400 to-red-600', icon: 'ph-dna' },
                    { id: 'ALL', name: '全範囲総合', color: 'from-indigo-500 to-purple-600', icon: 'ph-star' },
                ];
                const stats = app.getHistoryStats();
                const progress = (id) => {
                    if (id === 'ALL') return Math.round(stats.rate);
                    const unitQs = window.questionPool.filter(q => q.unit === id);
                    if (!unitQs.length) return 0;
                    const solved = unitQs.filter(q => app.state.history[q.id]?.correct > 0).length;
                    return Math.round((solved / unitQs.length) * 100);
                };

                let html = `
                    <div class="animate-fade-in space-y-8 pb-10">
                        <div class="glass-panel p-6 md:p-8 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-6">
                            <div><h2 class="text-2xl font-bold text-slate-800 mb-2">Let's Study!</h2><p class="text-slate-500">学習する単元を選んでください。</p></div>
                            <div class="flex gap-4 md:gap-8">
                                <div class="text-center"><div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Total Ans</div><div class="text-2xl font-bold text-slate-700 font-mono-num">${stats.total}</div></div>
                                <div class="text-center"><div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Accuracy</div><div class="text-2xl font-bold ${stats.rate >= 80 ? 'text-green-500' : 'text-blue-500'} font-mono-num">${stats.rate}%</div></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-700 mb-4 px-2 flex items-center gap-2"><i class="ph ph-squares-four text-indigo-500"></i> Select Unit</h3>
                            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                ${units.map(u => {
                    const p = progress(u.id);
                    return `<button onclick="app.selectUnit('${u.id}', '${u.name}')" class="group relative overflow-hidden rounded-2xl glass-panel p-6 text-left transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border-0 ring-1 ring-white/50">
                                        <div class="absolute bottom-0 left-0 w-full transition-all duration-1000 ease-out bg-gradient-to-t ${u.color} opacity-20" style="height: ${p}%"></div>
                                        <div class="absolute inset-0 bg-gradient-to-br ${u.color} opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex flex-col h-full justify-between gap-4">
                                            <div class="flex justify-between items-start"><div class="bg-gradient-to-br ${u.color} w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-md"><i class="ph ${u.icon} text-2xl"></i></div>${p > 0 ? `<div class="text-xs font-bold font-mono-num text-slate-400 bg-white/50 px-2 py-1 rounded-full">${p}%</div>` : ''}</div>
                                            <div><div class="text-xs font-bold text-slate-400 mb-1">${u.id === 'ALL' ? 'SPECIAL' : 'UNIT ' + u.id}</div><div class="font-bold text-lg text-slate-700 leading-tight">${u.name}</div></div>
                                        </div>
                                    </button>`;
                }).join('')}
                            </div>
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
            },

            selectUnit: (unitId, unitName) => {
                app.state.selectedUnit = unitId;
                app.state.selectedUnitName = unitName;
                const levels = [
                    { id: 1, name: '知識', sub: 'Basic Knowledge', count: 10, icon: 'ph-book-open-text', color: 'text-blue-500', bg: 'bg-blue-50' },
                    { id: 2, name: '思考', sub: 'Standard Thinking', count: 5, icon: 'ph-brain', color: 'text-amber-500', bg: 'bg-amber-50' },
                    { id: 3, name: '応用', sub: 'Advanced Logic', count: 3, icon: 'ph-flask', color: 'text-rose-500', bg: 'bg-rose-50' },
                    { id: 4, name: '本番形式', sub: 'Full Mock Exam', count: 20, icon: 'ph-exam', color: 'text-purple-500', bg: 'bg-purple-50' }
                ];

                // --- Filter Checkboxes HTML ---
                const filterOptions = [
                    { key: 'clear', label: 'クリア済み', icon: 'ph-check-circle', color: 'text-emerald-500' },
                    { key: 'winning', label: '勝ち越し', icon: 'ph-scales', color: 'text-blue-500' },
                    { key: 'revenge', label: 'リベンジ', icon: 'ph-fire', color: 'text-orange-500' },
                    { key: 'unanswered', label: '未回答', icon: 'ph-question', color: 'text-slate-500' },
                ];

                const isAll = app.state.quizFilter.all;

                const filterHtml = `
                    <div class="bg-white/80 p-4 rounded-xl mb-6 shadow-sm border border-slate-100">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">出題対象設定</div>
                        <div class="flex flex-col gap-3">
                            <!-- All Questions Option -->
                            <label class="custom-checkbox flex items-center gap-2 cursor-pointer group select-none">
                                <input type="checkbox" class="hidden" 
                                    ${isAll ? 'checked' : ''} 
                                    onchange="app.state.quizFilter.all = this.checked; app.selectUnit('${unitId}', '${unitName}')">
                                <div class="w-5 h-5 border-2 border-indigo-500 rounded flex items-center justify-center transition-all ${isAll ? 'bg-indigo-500' : 'bg-white'}">
                                    <svg class="w-3 h-3 text-white ${isAll ? 'block' : 'hidden'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                                <span class="text-sm font-bold ${isAll ? 'text-indigo-600' : 'text-slate-600'} transition-colors flex items-center gap-1">
                                    <i class="ph ph-list-checks text-lg"></i> 全問題数を含める
                                </span>
                            </label>

                            <div class="w-full h-px bg-slate-200 my-1"></div>

                            <!-- Specific Filters -->
                            <div class="flex flex-wrap gap-4 ${isAll ? 'opacity-50 pointer-events-none' : ''}">
                                ${filterOptions.map(opt => `
                                    <label class="custom-checkbox flex items-center gap-2 cursor-pointer group select-none">
                                        <input type="checkbox" class="hidden" 
                                            ${app.state.quizFilter[opt.key] ? 'checked' : ''} 
                                            onchange="app.state.quizFilter['${opt.key}'] = this.checked"
                                            ${isAll ? 'disabled' : ''}>
                                        <div class="w-5 h-5 border-2 border-slate-300 rounded flex items-center justify-center transition-all bg-white group-hover:border-indigo-400">
                                            <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                        <span class="text-sm font-bold text-slate-600 group-hover:text-indigo-600 transition-colors flex items-center gap-1">
                                            <i class="ph ${opt.icon} ${opt.color}"></i> ${opt.label}
                                        </span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                let html = `
                    <div class="animate-fade-in max-w-3xl mx-auto">
                        <button onclick="app.renderHome()" class="flex items-center text-slate-500 hover:text-indigo-600 mb-6 transition-colors group"><i class="ph ph-arrow-left text-xl mr-2 group-hover:-translate-x-1 transition-transform"></i><span class="font-medium">単元一覧に戻る</span></button>
                        <div class="text-center mb-6"><span class="inline-block px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 text-xs font-bold tracking-wider mb-2">SELECTED UNIT</span><h2 class="text-3xl font-bold text-slate-800 mb-1">${unitName}</h2><p class="text-slate-500">今の実力に合わせてコースを選んでください</p></div>
                        
                        ${filterHtml}
                        
                        <div class="grid gap-4">
                            ${levels.map(l => `<button onclick="${l.id === 4 ? `app.renderExamSetup('${l.id}')` : `app.startQuizSetup('${l.id}')`}" class="glass-panel p-5 rounded-2xl flex items-center justify-between group hover:border-indigo-300 hover:shadow-lg transition-all duration-300">
                                    <div class="flex items-center gap-5"><div class="${l.bg} ${l.color} w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-sm group-hover:scale-110 transition-transform duration-300"><i class="ph ${l.icon}"></i></div><div class="text-left"><div class="font-bold text-lg text-slate-700 group-hover:text-indigo-600 transition-colors">${l.name}</div><div class="text-xs text-slate-400 font-mono tracking-wider">${l.sub}</div></div></div>
                                    <div class="flex items-center gap-4"><span class="text-xs bg-slate-100 text-slate-500 font-bold px-2 py-1 rounded">${l.id === 4 ? '用紙スタイル' : 'カード形式'}</span><i class="ph ph-caret-right text-slate-300 group-hover:text-indigo-500 text-xl"></i></div>
                                </button>`).join('')}
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
            },

            renderExamSetup: (levelId) => {
                const html = `
                    <div class="animate-fade-in max-w-lg mx-auto w-full pt-12">
                        <button onclick="app.selectUnit(app.state.selectedUnit, app.state.selectedUnitName)" class="flex items-center text-slate-500 hover:text-indigo-600 mb-8 transition-colors group"><i class="ph ph-arrow-left text-xl mr-2 group-hover:-translate-x-1 transition-transform"></i><span class="font-medium">戻る</span></button>
                        
                        <div class="bg-white rounded-3xl p-8 border-2 border-slate-900">
                            <h2 class="text-2xl font-bold text-slate-900 mb-2 flex items-center gap-3"><i class="ph ph-exam text-slate-900"></i> 本番形式テスト設定</h2>
                            <p class="text-slate-500 text-sm mb-8">以下の設定でテストを開始します。</p>

                            <div class="space-y-6 mb-10">
                                <div class="bg-slate-50 p-4 rounded-xl flex items-center justify-between border border-slate-200">
                                    <span class="font-bold text-slate-500 text-sm">科目</span>
                                    <span class="font-bold text-slate-900 text-lg">化学</span>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl flex items-center justify-between border border-slate-200">
                                    <span class="font-bold text-slate-500 text-sm">単元</span>
                                    <span class="font-bold text-slate-900 text-lg">${app.state.selectedUnitName}</span>
                                </div>
                                <div>
                                    <div class="flex justify-between items-end mb-3">
                                        <span class="font-bold text-slate-500 text-sm">時間制限</span>
                                        <span class="font-bold text-slate-900 text-2xl font-mono-num"><span id="timeDisplay">60</span> 分</span>
                                    </div>
                                    <input type="range" min="10" max="60" step="5" value="60" 
                                        class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-900"
                                        oninput="document.getElementById('timeDisplay').innerText = this.value; app.state.examTimeLimit = parseInt(this.value)">
                                    <div class="flex justify-between text-[10px] text-slate-400 font-bold mt-2">
                                        <span>10分</span>
                                        <span>60分</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="app.renderExamTransition()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-700 transition-all text-lg flex items-center justify-center gap-2">
                                次へ進む <i class="ph ph-arrow-right"></i>
                            </button>
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
            },

            renderExamTransition: () => {
                const html = `
                    <div class="animate-fade-in fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 text-center">
                        <div class="max-w-md w-full animate-fade-in-up">
                            <p class="text-indigo-500 font-bold tracking-widest uppercase mb-4 text-sm">Ready to Start?</p>
                            <h2 class="text-4xl font-bold text-slate-800 mb-6 leading-tight">
                                化学<br>
                                <span class="text-2xl text-slate-600 mt-2 block border-t border-slate-200 pt-4 mt-4 w-1/2 mx-auto">${app.state.selectedUnitName}</span>
                            </h2>
                            <div class="inline-flex items-center gap-2 bg-slate-100 px-6 py-2 rounded-full text-slate-600 font-bold font-mono-num mb-12">
                                <i class="ph ph-timer text-xl"></i> 時間制限 ${app.state.examTimeLimit} 分
                            </div>
                            
                            <p class="text-xl text-slate-700 font-bold mb-10">それでは始めてください</p>
                            
                            <button onclick="app.startQuizSetup('4')" class="w-full max-w-[280px] mx-auto py-4 bg-white text-slate-900 border-2 border-slate-900 rounded-2xl font-bold hover:bg-slate-50 transition-all text-lg flex items-center justify-center gap-2">
                                <i class="ph ph-file-text"></i> 問題用紙を開く
                            </button>
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
            },

            // --- QUIZ & EXAM LOGIC ---

            // Logic to prepare a question with randomized choices
            generateQuizQuestion: (rawQ) => {
                const q = JSON.parse(JSON.stringify(rawQ));

                // Handle Variations (vars) if present
                if (q.vars && Array.isArray(q.vars) && q.vars.length > 0) {
                    const variant = q.vars[Math.floor(Math.random() * q.vars.length)];
                    // Merge variant properties into q
                    Object.assign(q, variant);
                }

                if (q.type !== 'choice') return q;

                // Prepare options: 1 correct + 3 wrongs
                const wrongCandidates = [...(q.wrongs || [])];
                const selectedWrongs = wrongCandidates.sort(() => 0.5 - Math.random()).slice(0, 3);

                // Combine and shuffle
                const pool = [q.correct, ...selectedWrongs];
                const shuffled = pool.sort(() => 0.5 - Math.random());

                // Set new properties
                q.options = shuffled;
                q.ans = shuffled.indexOf(q.correct); // ans becomes index

                return q;
            },

            startQuizSetup: (levelId) => {
                app.state.selectedLevel = parseInt(levelId);
                const unit = app.state.selectedUnit;
                const level = app.state.selectedLevel;
                const filter = app.state.quizFilter;

                let base = window.questionPool;

                // 1. Unit Filter
                if (unit !== 'ALL') base = base.filter(q => q.unit === unit);

                // 2. Status Filter
                base = base.filter(q => {
                    const h = app.state.history[q.id];
                    const streak = h ? h.streak : 0;
                    const correct = h ? h.correct : 0;
                    const wrong = h ? h.wrong : 0;
                    const isWinning = h && correct > wrong;

                    if (filter.all) return true;

                    if (!filter.clear && !filter.winning && !filter.revenge && !filter.unanswered) return true;

                    let matches = false;
                    if (filter.unanswered && !h) matches = true;
                    if (filter.clear && streak >= 3) matches = true;
                    if (filter.revenge && streak < 0) matches = true;
                    if (filter.winning && isWinning) matches = true;

                    return matches;
                });

                let filtered = [];
                if (level === 4) {
                    filtered = base.sort(() => 0.5 - Math.random()).slice(0, 10);
                } else {
                    let levelMatch = base.filter(q => q.level === level);
                    const counts = { 1: 10, 2: 5, 3: 3 };
                    filtered = levelMatch.sort(() => 0.5 - Math.random()).slice(0, counts[level]);
                }

                // If not enough questions, use all available
                if (filtered.length === 0) {
                    app.showAlert("条件に一致する問題がありません。\nフィルタ設定を確認してください。");
                    return;
                }

                // 3. Generate randomized options for selected questions
                const quizList = filtered.map(q => app.generateQuizQuestion(q));

                if (level === 4) app.runExam(quizList, 'normal'); else app.runQuiz(quizList, 'normal');
            },

            // ==========================================
            // QUIZ MODE
            // ==========================================
            runQuiz: (questions, mode = 'normal', fromScreen = 'home') => {
                app.cleanup();
                app.state.quizList = questions;
                app.state.mode = mode;
                app.state.fromScreen = fromScreen;
                app.state.currentQuizIndex = 0;
                app.state.quizFeedback = null;
                app.state.answers = [];
                app.state.currentScreen = 'quiz';
                app.state.selectedOptionIndex = null;

                document.body.classList.add('mode-immersive');
                document.getElementById('mainHeader').classList.add('hidden');
                document.getElementById('mainFooter').classList.add('hidden');
                document.body.style.background = '#f0f4f8';

                const c = document.getElementById('mainContainer');
                c.className = 'w-full h-full p-0 m-0';
                c.style.width = '100vw';
                c.style.height = '100vh';
                c.style.overflow = 'hidden';

                c.innerHTML = `
                    <div class="relative w-full h-full flex flex-col items-center">
                        ${app.getToolbarHTML()}
                        <div id="quizLayer" class="absolute inset-0 flex items-center p-4 pointer-events-none w-full h-full transition-all duration-300 overflow-y-auto ${app.getCardAlignmentClass()}">
                            <div id="quizCardContainer" class="flip-container pointer-events-auto"></div>
                        </div>
                        <canvas id="drawingCanvas" class="absolute inset-0 z-0 drawing-cursor touch-none"></canvas>
                    </div>
                `;
                document.addEventListener('keydown', app.handleQuizKeydown);
                setTimeout(() => app.setupCanvas(true), 100);
                app.renderQuizCard();
                app.state.questionStartTime = Date.now();
                app.startTimer();
            },

            getCardAlignmentClass: () => { return app.state.cardAlignment === 'left' ? 'justify-start pl-8 md:pl-20' : 'justify-center'; },

            toggleCardAlignment: () => {
                app.state.cardAlignment = app.state.cardAlignment === 'center' ? 'left' : 'center';
                const isLeft = app.state.cardAlignment === 'left';
                const icon = document.getElementById('alignIcon');
                if (icon) icon.className = app.state.cardAlignment === 'center' ? 'ph ph-align-left text-lg' : 'ph ph-align-center-horizontal text-lg';
                const quizLayer = document.getElementById('quizLayer');
                if (quizLayer) {
                    quizLayer.className = `absolute inset-0 flex items-center p-4 pointer-events-none w-full h-full transition-all duration-300 overflow-y-auto ${app.getCardAlignmentClass()}`;
                }
                const examPaper = document.getElementById('examPaper');
                if (examPaper) {
                    if (isLeft) {
                        examPaper.classList.remove('mx-auto', 'origin-top');
                        examPaper.classList.add('ml-8', 'mr-auto', 'origin-top-left');
                    } else {
                        examPaper.classList.add('mx-auto', 'origin-top');
                        examPaper.classList.remove('ml-8', 'mr-auto', 'origin-top-left');
                    }
                }
            },

            getToolbarHTML: () => {
                const backAction = `app.handleCloseButton()`;
                const alignIconClass = app.state.cardAlignment === 'center' ? 'ph-align-left' : 'ph-align-center-horizontal';
                return `
                    <div class="floating-bar floating-top">
                        <div class="flex items-center gap-2 font-mono text-base font-bold text-slate-700"><i class="ph ph-clock text-indigo-500"></i><span id="timerDisplay">00:00</span></div>
                        <div class="w-px h-6 bg-slate-200"></div>
                        <div class="flex items-center gap-1.5">
                            <button onclick="app.setPenColor('#333333')" class="w-6 h-6 rounded-full bg-[#333333] border border-white ring-2 ring-transparent hover:ring-indigo-400 transition-all"></button>
                            <button onclick="app.setPenColor('#ef4444')" class="w-6 h-6 rounded-full bg-[#ef4444] border border-white ring-2 ring-transparent hover:ring-indigo-400 transition-all"></button>
                            <button onclick="app.setPenMode('eraser')" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"><i class="ph ph-eraser text-lg"></i></button>
                            <button onclick="app.clearCanvas()" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors" title="クリア"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                        <div class="w-px h-6 bg-slate-200"></div>
                        <div class="flex items-center gap-1">
                            <button onclick="app.zoomCanvas(-0.1)" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"><i class="ph ph-minus text-lg"></i></button>
                            <button onclick="app.resetZoom()" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"><i class="ph ph-magnifying-glass text-lg"></i></button>
                            <button onclick="app.zoomCanvas(0.1)" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors"><i class="ph ph-plus text-lg"></i></button>
                        </div>
                        <div class="w-px h-6 bg-slate-200"></div>
                        <button onclick="app.toggleCardAlignment()" class="p-1.5 rounded-full hover:bg-slate-100 text-slate-500 transition-colors" title="配置切り替え"><i id="alignIcon" class="ph ${alignIconClass} text-lg"></i></button>
                        <div class="w-px h-6 bg-slate-200"></div>
                        <button onclick="app.confirm('終了しますか？', () => ${backAction})" class="text-xs font-bold text-slate-400 hover:text-rose-500 px-1"><i class="ph ph-x text-lg"></i></button>
                    </div>`;
            },

            giveUp: () => {
                if (app.state.quizFeedback) return;
                app.submitQuizAnswer(null); // Treat as null for wrong
            },

            renderQuizCard: () => {
                const container = document.getElementById('quizCardContainer');
                if (!container) return;
                const q = app.state.quizList[app.state.currentQuizIndex];
                const total = app.state.quizList.length;
                const selIdx = app.state.selectedOptionIndex;
                let frontInput = '';
                if (q.type === 'choice') {
                    frontInput = `<div class="grid grid-cols-1 gap-2 mt-4">${q.options.map((opt, idx) => {
                        const isSelected = selIdx === idx;
                        const btnClass = isSelected ? "w-full text-left p-3 rounded-xl border-2 border-indigo-500 bg-indigo-50 transition-all flex items-center group shadow-sm quiz-option selected" : "w-full text-left p-3 rounded-xl border-2 border-slate-100 hover:border-indigo-400 hover:bg-indigo-50 transition-all flex items-center group quiz-option";
                        const badgeClass = isSelected ? "w-6 h-6 rounded-full border border-indigo-500 bg-indigo-500 text-white flex items-center justify-center text-xs font-bold mr-3 transition-colors option-badge" : "w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-400 group-hover:text-indigo-600 group-hover:border-indigo-600 mr-3 transition-colors option-badge";
                        return `<button id="option-btn-${idx}" onclick="app.submitQuizAnswer(${idx})" class="${btnClass}"><div class="${badgeClass}">${idx + 1}</div><span class="text-sm font-bold text-slate-700">${opt}</span></button>`;
                    }).join('')}</div>`;
                } else {
                    frontInput = `<div class="mt-4 flex flex-col gap-2"><input type="text" id="quizInput" class="p-4 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none text-center font-mono text-xl font-bold" placeholder="答えを入力" autocomplete="off"><button onclick="app.submitQuizAnswer(document.getElementById('quizInput').value)" class="py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">解答する</button></div>`;
                }

                const giveUpBtn = `<div class="absolute bottom-4 right-4"><button onclick="app.giveUp()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 transition-colors flex items-center gap-1 px-2 py-1 rounded hover:bg-rose-50"><i class="ph ph-flag"></i> Give Up</button></div>`;

                container.innerHTML = `<div id="quizCardInner" class="flip-inner"><div class="flip-front relative pb-10"><div class="flex justify-between items-center mb-4"><span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full">Q ${app.state.currentQuizIndex + 1} / ${total}</span><span class="text-[10px] text-slate-400 font-mono">ID: ${q.id}</span></div><h3 class="text-lg font-bold text-slate-800 leading-relaxed mb-6">${q.q}</h3>${frontInput}${q.type !== 'choice' ? '<p class="text-center text-xs text-slate-400 mt-2 font-bold">Enterキーで解答</p>' : '<p class="text-center text-xs text-slate-400 mt-2 font-bold">数字キーで選択 / Enterで決定</p>'}${giveUpBtn}</div><div class="flip-back" id="quizCardBackContent"></div></div>`;
                if (q.type !== 'choice') setTimeout(() => document.getElementById('quizInput')?.focus(), 50);
                if (window.MathJax) MathJax.typesetPromise();
            },

            updateSelectionHighlight: () => {
                const q = app.state.quizList[app.state.currentQuizIndex];
                if (q.type !== 'choice') return;
                const selIdx = app.state.selectedOptionIndex;
                q.options.forEach((_, idx) => {
                    const btn = document.getElementById(`option-btn-${idx}`);
                    if (btn) {
                        const badge = btn.querySelector('div');
                        if (idx === selIdx) {
                            btn.className = "w-full text-left p-3 rounded-xl border-2 border-indigo-500 bg-indigo-50 transition-all flex items-center group shadow-sm quiz-option selected";
                            badge.className = "w-6 h-6 rounded-full border border-indigo-500 bg-indigo-500 text-white flex items-center justify-center text-xs font-bold mr-3 transition-colors option-badge";
                        } else {
                            btn.className = "w-full text-left p-3 rounded-xl border-2 border-slate-100 hover:border-indigo-400 hover:bg-indigo-50 transition-all flex items-center group quiz-option";
                            badge.className = "w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-400 group-hover:text-indigo-600 group-hover:border-indigo-600 mr-3 transition-colors option-badge";
                        }
                    }
                });
            },

            handleQuizKeydown: (e) => {
                if (app.state.currentScreen !== 'quiz') return;
                const q = app.state.quizList[app.state.currentQuizIndex];
                if (app.state.quizFeedback) { if (e.key === 'Enter') { e.preventDefault(); app.nextQuestion(); } return; }
                if (q.type === 'choice') {
                    const count = q.options.length;
                    let current = app.state.selectedOptionIndex;
                    if (e.key === 'ArrowDown') { e.preventDefault(); current = (current === null) ? 0 : (current + 1) % count; app.state.selectedOptionIndex = current; app.updateSelectionHighlight(); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); current = (current === null) ? count - 1 : (current - 1 + count) % count; app.state.selectedOptionIndex = current; app.updateSelectionHighlight(); }
                    else if (e.key >= '1' && e.key <= '9') { const idx = parseInt(e.key) - 1; if (idx < count) { app.state.selectedOptionIndex = idx; app.updateSelectionHighlight(); } }
                    else if (e.key === 'Enter') { e.preventDefault(); if (current !== null) app.submitQuizAnswer(current); }
                } else { if (e.key === 'Enter') { const input = document.getElementById('quizInput'); if (input) app.submitQuizAnswer(input.value); } }
            },

            submitQuizAnswer: (userVal) => {
                if (app.state.quizFeedback) return;
                const q = app.state.quizList[app.state.currentQuizIndex];
                let isCorrect = false;

                if (userVal === null) {
                    isCorrect = false;
                } else if (q.type === 'choice') {
                    isCorrect = (userVal === q.ans);
                } else {
                    const normalizedUser = String(userVal).trim();
                    const normalizedAns = String(q.ans).trim();
                    isCorrect = (normalizedUser === normalizedAns);
                }

                const now = Date.now();
                const timeTaken = (now - app.state.questionStartTime) / 1000;
                app.state.answers.push({ qId: q.id, qData: q, userAns: userVal, isCorrect: isCorrect, timeTaken: timeTaken });

                if (app.state.mode !== 'practice') {
                    app.saveQuestionHistory(q.id, isCorrect, timeTaken);
                    if (!isCorrect && !app.state.mistakes.includes(q.id)) app.state.mistakes.push(q.id);
                    if (isCorrect && app.state.mistakes.includes(q.id)) app.state.mistakes = app.state.mistakes.filter(id => id !== q.id);
                    localStorage.setItem('chemMaster_mistakes', JSON.stringify(app.state.mistakes));
                }

                app.state.quizFeedback = { isCorrect };
                const backContent = document.getElementById('quizCardBackContent');
                backContent.className = `flip-back ${isCorrect ? 'bg-emerald-50' : 'bg-rose-50'} transition-colors`;
                const total = app.state.quizList.length;
                const isLast = app.state.currentQuizIndex >= total - 1;
                let btnLabel = isLast ? (app.state.mode === 'practice' ? '図鑑に戻る' : '結果を見る') : '次の問題へ';
                let btnAction = isLast ? (app.state.mode === 'practice' ? 'app.goDictionary()' : 'app.finishQuiz()') : 'app.nextQuestion()';

                let correctText = "";
                if (q.type === 'choice') {
                    correctText = q.options[q.ans];
                } else {
                    correctText = q.ans;
                }

                backContent.innerHTML = `<div class="absolute top-4 right-4 text-xs font-mono font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">Time: ${timeTaken.toFixed(1)}s</div><div class="flex-grow flex flex-col items-center justify-center text-center p-4 pt-12"><div class="mb-2 text-5xl ${isCorrect ? 'text-emerald-500' : 'text-rose-500'}">${isCorrect ? '<i class="ph ph-check-circle"></i>' : '<i class="ph ph-x-circle"></i>'}</div><h3 class="text-2xl font-bold ${isCorrect ? 'text-emerald-600' : 'text-rose-600'} mb-1">${isCorrect ? 'Excellent!' : 'Don\'t mind!'}</h3><div class="text-sm text-slate-500 mb-4"><span class="font-bold">正解:</span> <span class="font-mono font-bold text-slate-700 text-lg ml-2">${correctText}</span></div><div class="bg-slate-50 p-4 rounded-xl text-left w-full text-sm text-slate-600 leading-relaxed border border-slate-100 overflow-y-auto max-h-40 custom-scrollbar"><span class="font-bold text-indigo-500 block mb-1">解説</span>${q.exp}</div></div><button onclick="${btnAction}" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg active:scale-95 flex items-center justify-center gap-2">${btnLabel} <i class="ph ph-arrow-right"></i></button><p class="text-center text-[10px] text-slate-300 mt-2 font-bold">Enterキーで進む</p>`;
                if (window.MathJax) MathJax.typesetPromise();
                document.getElementById('quizCardInner').classList.add('flipped');
            },

            nextQuestion: () => {
                const total = app.state.quizList.length;
                if (app.state.currentQuizIndex < total - 1) { app.state.currentQuizIndex++; app.state.quizFeedback = null; app.state.selectedOptionIndex = null; app.clearCanvas(); app.renderQuizCard(); app.state.questionStartTime = Date.now(); }
                else { if (app.state.mode === 'practice') app.goDictionary(); else app.finishQuiz(); }
            },

            // ==========================================
            // EXAM MODE
            // ==========================================
            runExam: (questions, mode = 'normal') => {
                app.cleanup();
                app.state.quizList = questions;
                app.state.mode = mode;
                app.state.mockAnswers = {};
                app.state.currentScreen = 'exam';
                app.state.scale = 1.0;
                app.state.isAnswerSheetOpen = false;
                app.state.startTime = Date.now(); // Reset start time for correct countdown adjustment

                document.body.classList.add('mode-immersive');
                document.getElementById('mainHeader').classList.add('hidden');
                document.getElementById('mainFooter').classList.add('hidden');
                document.body.style.background = '#f0f4f8';

                const c = document.getElementById('mainContainer');
                c.className = 'w-full h-full p-0 m-0';
                c.style.width = '100vw';
                c.style.height = '100vh';
                c.style.overflow = 'hidden';

                app.renderExam();
                app.startTimer();
                setTimeout(() => { app.setupCanvas(false); app.observePaperResize(); }, 100);
            },

            updateAnsweredCount: () => {
                const total = app.state.quizList.length;
                const answered = Object.keys(app.state.mockAnswers).length;
                const el = document.getElementById('answeredCount');
                if (el) el.innerText = `${answered} / ${total}`;

                const meta = document.getElementById('answerSheetMeta');
                if (meta) meta.innerText = `全${total}問 (回答済: ${answered})`;
            },

            toggleAnswerSheet: () => {
                const panel = document.getElementById('answerSheetPanel');
                if (!panel) return;
                app.state.isAnswerSheetOpen = !app.state.isAnswerSheetOpen;
                if (app.state.isAnswerSheetOpen) {
                    panel.classList.add('open');
                } else {
                    panel.classList.remove('open');
                }
            },

            setupAnswerSheetForm: () => {
                const container = document.getElementById('answerSheetForm');
                if (!container) return;

                container.innerHTML = app.state.quizList.map((q, idx) => {
                    let inputHtml = '';
                    if (q.type === 'choice') {
                        inputHtml = `<div class="flex gap-2 justify-center mt-1">
                            ${q.options.map((_, optIdx) => {
                            const isSelected = app.state.mockAnswers[q.id] === optIdx;
                            return `<button onclick="app.setMockAnswer('${q.id}', ${optIdx})" class="w-8 h-8 rounded-full border ${isSelected ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-300 text-slate-500 hover:border-indigo-400'} font-bold transition-all text-sm flex items-center justify-center">${optIdx + 1}</button>`;
                        }).join('')}
                        </div>`;
                    } else {
                        const val = app.state.mockAnswers[q.id] || '';
                        inputHtml = `<input type="text" value="${val}" onchange="app.setMockAnswer('${q.id}', this.value)" class="w-full p-2 border border-slate-300 rounded-lg text-center font-mono font-bold focus:border-indigo-500 outline-none text-sm" placeholder="解答">`;
                    }

                    return `<div class="mb-4 pb-4 border-b border-slate-100 last:border-0">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-slate-500">問${idx + 1}</span>
                            ${app.state.mockAnswers[q.id] !== undefined ? '<i class="ph ph-check-circle text-indigo-500"></i>' : ''}
                        </div>
                        ${inputHtml}
                    </div>`;
                }).join('');
            },

            setMockAnswer: (qId, val) => {
                app.state.mockAnswers[qId] = val;
                app.updateAnsweredCount();
                app.setupAnswerSheetForm();
            },

            submitMockExamConfirm: () => {
                const total = app.state.quizList.length;
                const answered = Object.keys(app.state.mockAnswers).length;
                app.confirm(`${total}問中${answered}問回答済みです。\n採点して終了しますか？`, () => {
                    app.finishMockExam();
                });
            },

            finishMockExam: () => {
                app.state.answers = app.state.quizList.map(q => {
                    const userVal = app.state.mockAnswers[q.id];
                    let isCorrect = false;
                    if (q.type === 'choice') {
                        isCorrect = (userVal === q.ans);
                    } else {
                        const normalizedUser = String(userVal || '').trim();
                        const normalizedAns = String(q.ans).trim();
                        isCorrect = (normalizedUser === normalizedAns);
                    }

                    const timeTaken = 0;
                    if (app.state.mode !== 'practice') {
                        app.saveQuestionHistory(q.id, isCorrect, timeTaken);
                        if (!isCorrect && !app.state.mistakes.includes(q.id)) app.state.mistakes.push(q.id);
                        if (isCorrect && app.state.mistakes.includes(q.id)) app.state.mistakes = app.state.mistakes.filter(id => id !== q.id);
                    }

                    return { qId: q.id, qData: q, userAns: userVal, isCorrect: isCorrect, timeTaken: 0 };
                });

                localStorage.setItem('chemMaster_mistakes', JSON.stringify(app.state.mistakes));
                app.toggleAnswerSheet();
                app.finishQuiz();
            },

            renderExam: () => {
                const questionsHtml = app.state.quizList.map((q, idx) => `<div class="question-block mb-12 relative z-0 pointer-events-none select-none" data-id="${q.id}"><div class="flex gap-4 mb-4"><span class="text-xl font-bold font-serif text-slate-800 whitespace-nowrap flex-shrink-0">問${idx + 1}</span><div class="flex-grow pt-1 text-lg font-medium text-slate-900 leading-loose font-serif">${q.q}${q.type === 'choice' ? `<div class="mt-4 pl-4 grid grid-cols-1 md:grid-cols-2 gap-y-2 text-base text-slate-700">${q.options.map((o, i) => `<div>① ${o}</div>`.replace('①', ['①', '②', '③', '④', '⑤', '⑥'][i])).join('')}</div>` : ''}</div></div><div class="h-64 border-b-2 border-dashed border-slate-300/50 w-full"></div></div>`).join('');

                const html = `
                    <div class="relative w-full h-full flex flex-col">
                        ${app.getToolbarHTML()}
                        <div id="examScrollContainer" class="flex-grow overflow-y-auto bg-slate-200/50 block w-full h-full pt-20 custom-scrollbar">
                            <div id="examPaper" class="mx-auto w-full max-w-4xl p-8 md:p-16 origin-top my-4 bg-white relative z-1">
                                <div id="questionsLayer" class="relative z-0">
                                    <div class="text-center mb-12 border-b-2 border-slate-800 pb-6"><h2 class="text-3xl font-bold font-serif mb-2 text-slate-900">化学 演習問題</h2><p class="text-slate-500 font-serif">注意事項：解答は右下の「解答用紙ボタン」から入力してください。</p></div>
                                    ${questionsHtml}
                                </div>
                                <canvas id="drawingCanvas" class="absolute inset-0 z-10 drawing-cursor touch-none"></canvas>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-6 right-6 z-[3000]">
                            <button onclick="app.toggleAnswerSheet()" class="bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-300 rounded-full px-5 py-4 flex items-center gap-3 transition-transform hover:-translate-y-1 hover:shadow-xl active:scale-95 group">
                                <i class="ph ph-pencil-simple text-2xl"></i>
                                <span class="font-bold text-sm hidden md:inline">解答用紙</span>
                                <span class="bg-white text-indigo-700 px-2 py-0.5 rounded-full text-xs font-bold font-mono-num" id="answeredCount">0 / ${app.state.quizList.length}</span>
                            </button>
                        </div>
                    </div>`;

                document.getElementById('mainContainer').innerHTML = html;
                app.updateAnsweredCount();
                app.setupAnswerSheetForm();
                if (window.MathJax) MathJax.typesetPromise();
            },

            // --- CANVAS ---
            setupCanvas: (isQuiz = false) => {
                let paper, canvas;
                const dpr = window.devicePixelRatio || 1;
                if (isQuiz) {
                    canvas = document.getElementById('drawingCanvas');
                    if (!canvas) return;
                    canvas.width = window.innerWidth * dpr;
                    canvas.height = window.innerHeight * dpr;
                    // For quiz, layout is handled by CSS (absolute inset-0)
                } else {
                    paper = document.getElementById('examPaper');
                    canvas = document.getElementById('drawingCanvas');
                    if (!paper || !canvas) return;
                    const w = paper.offsetWidth;
                    const h = paper.scrollHeight;
                    canvas.width = w * dpr;
                    canvas.height = h * dpr;
                    canvas.style.width = w + 'px';
                    canvas.style.height = h + 'px';
                }
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                app.state.canvasContext = ctx;
                app.setPenColor(app.state.penColor);
                app.addCanvasListeners(canvas, isQuiz ? null : paper);
            },
            addCanvasListeners: (canvas, zoomTarget = null) => {
                const getPos = (e) => { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const scale = zoomTarget ? app.state.scale : 1.0; return { x: (clientX - rect.left) / scale, y: (clientY - rect.top) / scale }; };
                const startDraw = (e) => { if (e.touches && e.touches.length > 1) return; app.state.isDrawing = true; const pos = getPos(e); app.state.lastX = pos.x; app.state.lastY = pos.y; };
                const draw = (e) => { if (!app.state.isDrawing) return; if (e.touches && e.touches.length > 1) return; const pos = getPos(e); const ctx = app.state.canvasContext; ctx.beginPath(); ctx.moveTo(app.state.lastX, app.state.lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); app.state.lastX = pos.x; app.state.lastY = pos.y; };
                const stopDraw = () => { app.state.isDrawing = false; };
                canvas.onmousedown = startDraw; canvas.onmousemove = draw; canvas.onmouseup = stopDraw; canvas.onmouseout = stopDraw;
                canvas.ontouchstart = (e) => { if (e.touches.length === 1) startDraw(e); else if (e.touches.length === 2 && zoomTarget) { app.state.isDrawing = false; app.state.initialPinchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); app.state.initialScale = app.state.scale; } };
                canvas.ontouchmove = (e) => { if (e.touches.length === 1) draw(e); else if (e.touches.length === 2 && app.state.initialPinchDistance && zoomTarget) { e.preventDefault(); const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); app.updateZoom(Math.min(Math.max(app.state.initialScale * (dist / app.state.initialPinchDistance), app.state.minScale), app.state.maxScale), zoomTarget); } };
                canvas.ontouchend = stopDraw;
            },
            updateZoom: (newScale, target) => { if (!target) return; app.state.scale = newScale; target.style.transform = `scale(${newScale})`; },
            zoomCanvas: (delta) => { const target = document.getElementById('examPaper'); if (!target) return; app.updateZoom(Math.min(Math.max(app.state.scale + delta, app.state.minScale), app.state.maxScale), target); },
            resetZoom: () => { const target = document.getElementById('examPaper'); if (!target) return; app.updateZoom(1.0, target); },
            setPenColor: (color) => { app.state.penColor = color; if (app.state.canvasContext) { app.state.canvasContext.globalCompositeOperation = 'source-over'; app.state.canvasContext.strokeStyle = color; app.state.canvasContext.lineWidth = 2; } },
            setPenMode: (mode) => { if (mode === 'eraser' && app.state.canvasContext) { app.state.canvasContext.globalCompositeOperation = 'destination-out'; app.state.canvasContext.lineWidth = 20; } },
            clearCanvas: () => { const canvas = document.getElementById('drawingCanvas'); if (canvas && app.state.canvasContext) app.state.canvasContext.clearRect(0, 0, canvas.width, canvas.height); },
            observePaperResize: () => {
                const paper = document.getElementById('examPaper'); const canvas = document.getElementById('drawingCanvas'); if (!paper || !canvas) return;
                const dpr = window.devicePixelRatio || 1;
                if (app.state.resizeObserver) app.state.resizeObserver.disconnect();
                app.state.resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const newHeight = paper.scrollHeight;
                        const newWidth = entry.contentRect.width;
                        if (Math.abs(canvas.height - (newHeight * dpr)) > 5) {
                            const savedData = canvas.toDataURL();
                            canvas.width = newWidth * dpr;
                            canvas.height = newHeight * dpr;
                            canvas.style.width = newWidth + 'px';
                            canvas.style.height = newHeight + 'px';
                            const ctx = canvas.getContext('2d');
                            ctx.scale(dpr, dpr);
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            app.state.canvasContext = ctx;
                            app.setPenColor(app.state.penColor);
                            const img = new Image();
                            img.onload = () => ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            img.src = savedData;
                        }
                    }
                }); app.state.resizeObserver.observe(paper);
            },

            // --- Dictionary & Others ---
            renderDictionary: () => {
                const { unit, level, status, search } = app.state.dictFilter;
                let list = window.questionPool;
                if (unit !== 'ALL') list = list.filter(q => q.unit === unit);
                if (level !== 'ALL') list = list.filter(q => q.level === parseInt(level));

                if (status === 'CLEAR') list = list.filter(q => (app.state.history[q.id]?.streak || 0) >= 3);
                if (status === 'WINNING') list = list.filter(q => {
                    const h = app.state.history[q.id];
                    return h && h.correct > h.wrong;
                });
                if (status === 'REVENGE') list = list.filter(q => (app.state.history[q.id]?.streak || 0) < 0);
                if (status === 'UNANSWERED') list = list.filter(q => !app.state.history[q.id]);

                let contentHtml = '';

                if (app.state.dictViewMode === 'list') {
                    // --- LIST VIEW ---
                    contentHtml = `<div class="flex flex-col gap-2">${list.map(q => {
                        const h = app.state.history[q.id] || { correct: 0, wrong: 0, streak: 0 };
                        const streak = h.streak || 0;

                        let badges = '';
                        if (streak >= 3) badges += `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-bold">CLEAR 🏆</span>`;
                        if (h.correct > h.wrong) badges += `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold">勝ち越し ⚖️</span>`;
                        if (streak < 0) badges += `<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-[10px] font-bold">リベンジ！ 🔥</span>`;

                        const isCleared = streak >= 3;
                        const bgClass = isCleared ? "bg-amber-50 border-amber-200" : "bg-white border-slate-200";
                        const iconHtml = isCleared ? `<div class="text-amber-500"><i class="ph ph-check-circle text-2xl"></i></div>` : `<div class="w-6"></div>`;

                        return `<div class="flex items-center gap-2 w-full">
                            <div class="flex-shrink-0 w-8 flex justify-center">${iconHtml}</div>
                            <div class="${bgClass} p-3 rounded-xl border hover:shadow-md transition-all flex items-center gap-3 group flex-grow min-w-0">
                                <span class="text-[10px] font-bold px-2 py-1 rounded text-center whitespace-nowrap min-w-[4.5rem] ${app.getUnitColor(q.unit)}">${app.unitMap[q.unit]}</span>
                                <span class="text-[10px] font-bold px-2 py-1 rounded text-center whitespace-nowrap min-w-[2.5rem] ${app.getLevelColor(q.level)}">${app.levelMap[q.level]}</span>
                                <div class="flex-grow min-w-0 text-slate-800 font-medium text-sm truncate group-hover:text-indigo-600 transition-colors">${q.q}</div>
                                <div class="flex items-center gap-2 text-[10px] text-slate-400 flex-shrink-0">
                                    <span class="flex items-center gap-0.5" title="正解数"><i class="ph ph-check-circle text-emerald-500"></i> ${h.correct || 0}</span>
                                    <span class="flex items-center gap-0.5" title="不正解数"><i class="ph ph-x-circle text-rose-500"></i> ${h.wrong || 0}</span>
                                </div>
                                <div class="flex items-center gap-1 flex-shrink-0">${badges}</div>
                                <button onclick="app.openDictModal('${q.id}')" class="p-1.5 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors flex-shrink-0"><i class="ph ph-info text-lg"></i></button>
                            </div>
                        </div>`;
                    }).join('')}</div>`;
                } else {
                    // --- GRID VIEW ---
                    contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${list.map(q => {
                        const h = app.state.history[q.id] || { correct: 0, wrong: 0, streak: 0 };
                        const streak = h.streak || 0;

                        let cardClass = "bg-white p-4 rounded-xl border transition-shadow hover:shadow-lg flex flex-col justify-between h-64";
                        let badges = '';

                        if (streak >= 3) { badges += `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded ml-2 text-xs font-bold">CLEAR 🏆</span>`; cardClass = "bg-amber-50 p-4 rounded-xl border border-amber-200 transition-shadow hover:shadow-lg flex flex-col justify-between h-64 relative overflow-hidden"; }
                        else if (h.correct > h.wrong) { badges += `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2 text-xs font-bold">勝ち越し ⚖️</span>`; }
                        if (streak < 0) { badges += `<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2 text-xs font-bold">リベンジ！ 🔥</span>`; cardClass += " border-orange-400 border-2"; }
                        else if (streak === 0 && streak < 3) cardClass += " border-slate-200";

                        const getIcon = streak >= 3 ? `<div class="absolute bottom-0 left-0 p-2 text-amber-500/20"><i class="ph ph-check-circle text-6xl transform -rotate-12"></i></div><div class="absolute bottom-3 left-3 text-amber-600 font-bold flex items-center gap-1 z-10"><i class="ph ph-check-circle text-xl"></i> GET!</div>` : '';

                        return `<div class="${cardClass}">${getIcon}<div class="relative z-10"><div class="flex justify-between items-start mb-2"><div class="flex items-center gap-1.5 flex-wrap"><span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${app.getUnitColor(q.unit)}">${app.unitMap[q.unit]}</span><span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${app.getLevelColor(q.level)}">${app.levelMap[q.level]}</span></div><span class="text-[10px] font-mono text-slate-300">${q.id}</span></div><div class="text-slate-800 font-medium text-sm mb-3 line-clamp-3 h-16 leading-relaxed">${q.q}</div><div class="flex gap-3 text-[10px] text-slate-400 font-mono mb-2 flex-wrap items-center"><span><i class="ph ph-check-circle text-emerald-500"></i> ${h.correct || 0}</span><span><i class="ph ph-x-circle text-rose-500"></i> ${h.wrong || 0}</span>${badges}</div></div><div class="flex justify-end mt-auto relative z-10"><button onclick="app.openDictModal('${q.id}')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 flex items-center justify-center transition-colors"><i class="ph ph-info text-lg"></i></button></div></div>`
                    }).join('')}</div>`;
                }

                let html = `
                    <div class="animate-fade-in w-full pb-12 container mx-auto px-4 max-w-7xl">
                        <div class="sticky top-4 z-30 bg-white/90 backdrop-blur-xl p-4 rounded-3xl shadow-xl shadow-slate-200/50 border border-white/60 mb-8 transition-all duration-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <button onclick="app.goMyPage()" class="text-slate-400 hover:text-indigo-600"><i class="ph ph-arrow-left text-xl"></i></button>
                                    <h2 class="text-2xl font-bold text-slate-800">問題図鑑</h2>
                                    <span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded-full">${list.length}問</span>
                                </div>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <button onclick="app.state.dictViewMode='grid'; app.renderDictionary()" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all ${app.state.dictViewMode === 'grid' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}"><i class="ph ph-squares-four text-lg"></i></button>
                                    <button onclick="app.state.dictViewMode='list'; app.renderDictionary()" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all ${app.state.dictViewMode === 'list' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}"><i class="ph ph-list-dashes text-lg"></i></button>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-4 items-center">
                                <select onchange="app.state.dictFilter.unit = this.value; app.renderDictionary()" class="bg-white border border-slate-300 rounded-lg text-sm p-2 outline-none shadow-sm focus:border-indigo-500 hover:border-indigo-400 transition-colors">
                                    ${['ALL', 'A', 'B', 'C', 'D', 'E', 'F'].map(u => `<option value="${u}" ${unit === u ? 'selected' : ''}>${u === 'ALL' ? '全単元' : app.unitMap[u]}</option>`).join('')}
                                </select>
                                <select onchange="app.state.dictFilter.level = this.value; app.renderDictionary()" class="bg-white border border-slate-300 rounded-lg text-sm p-2 outline-none shadow-sm focus:border-indigo-500 hover:border-indigo-400 transition-colors">
                                    ${['ALL', '1', '2', '3', '4'].map(l => `<option value="${l}" ${level === l ? 'selected' : ''}>${l === 'ALL' ? '全レベル' : app.levelMap[l]}</option>`).join('')}
                                </select>
                                <select onchange="app.state.dictFilter.status = this.value; app.renderDictionary()" class="bg-white border border-slate-300 rounded-lg text-sm p-2 outline-none shadow-sm focus:border-indigo-500 hover:border-indigo-400 transition-colors">
                                    <option value="ALL">全ステータス</option>
                                    <option value="CLEAR" ${status === 'CLEAR' ? 'selected' : ''}>クリア済み</option>
                                    <option value="WINNING" ${status === 'WINNING' ? 'selected' : ''}>勝ち越し ⚖️</option>
                                    <option value="REVENGE" ${status === 'REVENGE' ? 'selected' : ''}>リベンジ！</option>
                                    <option value="UNANSWERED" ${status === 'UNANSWERED' ? 'selected' : ''}>未回答</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pb-12 min-h-screen">
                            ${contentHtml}
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
                if (window.MathJax) MathJax.typesetPromise();
                const ctx = document.getElementById('statsChart').getContext('2d');
                if (app.state.chartInstance) app.state.chartInstance.destroy();
                app.state.chartInstance = new Chart(ctx, { type: 'radar', data: { labels: ['A.化学基礎', 'B.状態', 'C.反応', 'D.無機', 'E.有機', 'F.高分子'], datasets: [{ label: '攻略率 (%)', data: unitStats, backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(99, 102, 241, 1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { stepSize: 20, display: false } } }, plugins: { legend: { display: false } } } });
            },
            findQuestion: (id) => window.questionPool.find(q => q.id === id),
            openDictModal: (id) => {
                const q = app.findQuestion(id);
                if (!q) return;
                const h = app.state.history[q.id] || { correct: 0, wrong: 0, streak: 0 };
                const streak = h.streak || 0;

                let badges = '';
                if (streak >= 3) badges += `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded ml-2 text-xs font-bold">CLEAR 🏆</span>`;
                if (streak < 0) badges += `<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2 text-xs font-bold">リベンジ！ 🔥</span>`;

                let correctDisplay = "";
                let choicesHtml = "";

                if (q.type === 'choice') {
                    correctDisplay = q.correct;
                    const displayChoices = [q.correct, ...q.wrongs.slice(0, 3)].sort(() => 0.5 - Math.random());
                    choicesHtml = `<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-600">${displayChoices.map((o, i) => `<div class="flex gap-2 p-2 bg-white border border-slate-200 rounded"><span class="font-bold text-indigo-500">${i + 1}.</span> ${o}</div>`).join('')}</div>`;
                } else {
                    correctDisplay = q.ans;
                }

                const html = `
                    <div class="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-start rounded-t-3xl">
                        <div>
                            <div class="flex items-center gap-2 flex-wrap mb-2">
                                <span class="text-xs font-bold px-2 py-1 rounded ${app.getUnitColor(q.unit)}">${app.unitMap[q.unit]}</span>
                                <span class="text-xs font-bold px-2 py-1 rounded ${app.getLevelColor(q.level)}">${app.levelMap[q.level]}</span>
                                <span class="text-xs font-bold text-slate-400 font-mono">ID: ${q.id}</span>
                                ${badges}
                            </div>
                            <div class="text-xs text-slate-400 font-mono">正解: ${h.correct || 0}回 / 不正解: ${h.wrong || 0}回 / 連勝: ${streak > 0 ? streak : 0}</div>
                        </div>
                        <button onclick="app.closeDictModal()" class="text-slate-400 hover:text-rose-500 text-2xl transition-colors"><i class="ph ph-x-circle"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                        <div class="mb-6">
                            <h4 class="font-bold text-slate-400 text-xs mb-2 uppercase tracking-wider">問題</h4>
                            <p class="text-lg font-bold text-slate-800 leading-relaxed">${q.q}</p>
                            ${choicesHtml}
                        </div>
                        <div class="mt-4">
                            <button onclick="document.getElementById('dictExp').classList.remove('hidden'); this.classList.add('hidden')" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors flex items-center justify-center gap-2 text-sm"><i class="ph ph-eye"></i> 正解・解説を表示</button>
                            <div id="dictExp" class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 hidden animate-fade-in">
                                <h4 class="font-bold text-indigo-400 text-xs mb-2 uppercase tracking-wider">正解・解説</h4>
                                <div class="mb-3">
                                    <span class="font-bold text-slate-500 text-sm">正解:</span>
                                    <span class="font-mono font-bold text-indigo-700 text-lg ml-2">${correctDisplay}</span>
                                </div>
                                <div class="text-sm text-slate-700 leading-relaxed space-y-2 border-t border-indigo-200/50 pt-3">${q.exp}</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('dictModalContent').innerHTML = html;
                document.getElementById('dictModal').classList.remove('hidden');
                requestAnimationFrame(() => {
                    document.getElementById('dictModal').classList.remove('opacity-0');
                    document.getElementById('dictModalContent').classList.remove('scale-95', 'opacity-0');
                    document.getElementById('dictModalContent').classList.add('scale-100', 'opacity-100');
                });
                if (window.MathJax) MathJax.typesetPromise();
            },
            closeDictModal: () => { const m = document.getElementById('dictModal'); m.classList.add('opacity-0'); document.getElementById('dictModalContent').classList.remove('scale-100', 'opacity-100'); document.getElementById('dictModalContent').classList.add('scale-95', 'opacity-0'); setTimeout(() => { m.classList.add('hidden'); document.getElementById('dictModalContent').innerHTML = ''; }, 300); },

            startReviewSetup: () => { if (app.state.mistakes.length === 0) { app.showAlert("現在、間違いリストは空です。"); return; } const reviewQuestions = window.questionPool.filter(q => app.state.mistakes.includes(q.id)); if (reviewQuestions.length === 0) { app.showAlert("復習対象の問題データが見つかりませんでした。リストをクリアします。"); app.state.mistakes = []; localStorage.setItem('chemMaster_mistakes', JSON.stringify([])); app.renderMyPage(); return; } const shuffled = reviewQuestions.map(q => app.generateQuizQuestion(q)).sort(() => 0.5 - Math.random()); app.runQuiz(shuffled, 'review'); },

            finishQuiz: () => {
                app.cleanup(); const answers = app.state.answers; const correctCount = answers.filter(a => a.isCorrect).length; const score = Math.round((correctCount / answers.length) * 100); const isReview = app.state.mode === 'review'; const resultList = answers.map((a, idx) => {
                    let userAnsText = "";
                    let correctAnsText = "";
                    if (a.qData.type === 'choice') {
                        userAnsText = a.userAns !== null ? a.qData.options[a.userAns] : 'Give Up';
                        correctAnsText = a.qData.options[a.qData.ans];
                    } else {
                        userAnsText = a.userAns || '未回答';
                        correctAnsText = a.qData.ans;
                    }
                    return `<div class="bg-white/80 p-5 rounded-2xl border-l-[6px] ${a.isCorrect ? 'border-green-500' : 'border-rose-500'} shadow-sm mb-4 transition-transform hover:scale-[1.01]"><div class="flex justify-between items-start mb-3"><div class="flex items-center gap-3"><span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">Q${idx + 1}</span>${a.isCorrect ? '<span class="text-green-600 font-bold flex items-center gap-1"><i class="ph ph-check-circle"></i> 正解</span>' : '<span class="text-rose-500 font-bold flex items-center gap-1"><i class="ph ph-x-circle"></i> 不正解</span>'}</div></div><p class="mb-3 font-medium text-slate-800 leading-relaxed">${a.qData.q}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm"><div class="p-3 rounded-lg ${a.isCorrect ? 'bg-green-50 text-green-800' : 'bg-rose-50 text-rose-800'}"><div class="text-xs opacity-70 font-bold mb-1">あなたの解答</div><div class="font-bold">${userAnsText}</div></div>${!a.isCorrect ? `<div class="p-3 rounded-lg bg-indigo-50 text-indigo-800"><div class="text-xs opacity-70 font-bold mb-1">正解</div><div class="font-bold">${correctAnsText}</div></div>` : ''}</div><div class="bg-slate-50 p-4 rounded-xl text-sm text-slate-600 leading-relaxed border border-slate-100"><span class="font-bold text-indigo-500 block mb-1"><i class="ph ph-lightbulb"></i> 解説</span> ${a.qData.exp}</div></div>`
                }).join(''); let html = `<div class="max-w-3xl mx-auto animate-fade-in pb-12"><div class="glass-panel p-8 md:p-12 rounded-3xl text-center mb-8 relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div><h2 class="text-sm font-bold tracking-widest text-slate-400 uppercase mb-2">Result</h2><div class="flex items-center justify-center gap-1 mb-4"><span class="text-7xl md:text-8xl font-bold text-slate-800 font-mono-num tracking-tighter">${score}</span><span class="text-2xl text-slate-400 font-light mt-4">%</span></div><div class="flex justify-center gap-8 text-slate-500 mb-8 font-mono text-sm"><div class="flex flex-col items-center"><i class="ph ph-check-circle text-2xl text-green-500 mb-1"></i><span>${correctCount} / ${answers.length} Correct</span></div></div><div class="flex flex-col sm:flex-row justify-center gap-4"><button onclick="${app.state.mode === 'review' ? 'app.goMyPage()' : 'app.goHome()'}" class="px-6 py-3 rounded-xl font-bold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm">${app.state.mode === 'review' ? 'マイページへ' : 'ホームへ'}</button>${!isReview ? `<button onclick="app.startQuizSetup('${app.state.selectedLevel}')" class="px-8 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all hover:-translate-y-0.5">もう一度挑戦</button>` : ''}</div></div><div class="px-2"><h3 class="font-bold text-slate-600 mb-4 flex items-center gap-2"><i class="ph ph-list-dashes text-xl"></i> 詳細レポート</h3>${resultList}</div></div>`; document.getElementById('mainContainer').innerHTML = html; if (window.MathJax) MathJax.typesetPromise();
            },

            resetData: () => {
                app.confirm('学習データを全てリセットしますか？この操作は取り消せません。', () => {
                    localStorage.removeItem('chemMaster_history');
                    localStorage.removeItem('chemMaster_mistakes');
                    app.state.history = {};
                    app.state.mistakes = [];
                    app.showToast('データをリセットしました');
                    app.renderMyPage();
                });
            },

            renderMyPage: () => {
                const mistakeCount = app.state.mistakes.length;
                const units = ['A', 'B', 'C', 'D', 'E', 'F'];
                const allQs = window.questionPool;

                // --- Stats Calculation ---
                // 1. Overall
                const totalQ = allQs.length;
                const clearedQ = allQs.filter(q => (app.state.history[q.id]?.streak || 0) >= 3).length;
                const encounteredQ = allQs.filter(q => app.state.history[q.id]).length;

                const clearRate = totalQ > 0 ? Math.round((clearedQ / totalQ) * 100) : 0;
                const encounterRate = totalQ > 0 ? Math.round((encounteredQ / totalQ) * 100) : 0;

                // 2. Per Unit
                const unitStats = units.map(u => {
                    const unitQs = allQs.filter(q => q.unit === u);
                    if (!unitQs.length) return { id: u, clear: 0, encounter: 0, clearRate: 0 };
                    const enc = unitQs.filter(q => app.state.history[q.id]).length;
                    const clr = unitQs.filter(q => (app.state.history[q.id]?.streak || 0) >= 3).length;
                    return {
                        id: u,
                        clear: clr,
                        encounter: enc,
                        total: unitQs.length,
                        clearRate: Math.round((clr / unitQs.length) * 100),
                        encounterRate: Math.round((enc / unitQs.length) * 100)
                    };
                });

                const radarData = unitStats.map(u => u.clearRate);

                if (!app.state.unitBreakdownMode) app.state.unitBreakdownMode = 'clear';
                const isClearMode = app.state.unitBreakdownMode === 'clear';

                let html = `
                    <div class="animate-fade-in space-y-6 max-w-4xl mx-auto pb-12">
                        <div class="flex items-center gap-4 mb-4"><h2 class="text-3xl font-bold text-slate-800">My Page</h2><span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold">User Profile</span></div>
                        
                        <!-- Collection Status -->
                        <div class="glass-panel p-6 rounded-2xl">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2"><i class="ph ph-trophy text-amber-500 text-xl"></i> コレクション状況</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div class="bg-amber-50 p-6 rounded-2xl border border-amber-100 relative overflow-hidden">
                                     <div class="absolute right-0 top-0 p-4 opacity-10"><i class="ph ph-check-circle text-9xl text-amber-500"></i></div>
                                     <div class="relative z-10">
                                        <div class="text-xs font-bold text-amber-600 uppercase tracking-wider mb-1">Clear Rate</div>
                                        <div class="text-4xl font-bold text-amber-700 font-mono-num mb-2">${clearRate}% <span class="text-lg text-amber-600/60">(${clearedQ}/${totalQ})</span></div>
                                        <div class="w-full bg-amber-200 rounded-full h-2.5 overflow-hidden"><div class="bg-amber-500 h-2.5 rounded-full" style="width: ${clearRate}%"></div></div>
                                        <p class="text-[10px] text-amber-600/80 mt-2 font-bold">3連続正解して「GET」した問題の割合</p>
                                     </div>
                                </div>
                                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 relative overflow-hidden">
                                     <div class="absolute right-0 top-0 p-4 opacity-10"><i class="ph ph-eye text-9xl text-indigo-500"></i></div>
                                     <div class="relative z-10">
                                        <div class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-1">Encounter Rate</div>
                                        <div class="text-4xl font-bold text-indigo-700 font-mono-num mb-2">${encounterRate}% <span class="text-lg text-indigo-600/60">(${encounteredQ}/${totalQ})</span></div>
                                        <div class="w-full bg-indigo-200 rounded-full h-2.5 overflow-hidden"><div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${encounterRate}%"></div></div>
                                        <p class="text-[10px] text-indigo-600/80 mt-2 font-bold">一度でも遭遇した問題の割合</p>
                                     </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-slate-600 text-sm">Unit Breakdown</h4>
                                <div class="bg-slate-100 p-1 rounded-lg flex">
                                    <button onclick="app.state.unitBreakdownMode='clear'; app.renderMyPage()" class="px-3 py-1 rounded-md text-xs font-bold transition-all ${isClearMode ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}">Clear</button>
                                    <button onclick="app.state.unitBreakdownMode='encounter'; app.renderMyPage()" class="px-3 py-1 rounded-md text-xs font-bold transition-all ${!isClearMode ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}">Encounter</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                                ${unitStats.map(u => `
                                    <div class="bg-white border border-slate-100 p-3 rounded-xl text-center flex flex-col items-center justify-between h-full transition-all hover:shadow-md">
                                        <div class="text-[10px] font-bold ${app.getUnitColor(u.id)} rounded px-1.5 py-0.5 inline-block mb-2">${app.unitMap[u.id]}</div>
                                        <div class="w-full">
                                            <div class="flex flex-col items-center mb-1">
                                                <div class="flex items-baseline justify-center gap-0.5">
                                                    <span class="text-2xl font-bold ${isClearMode ? 'text-amber-500' : 'text-indigo-600'} font-mono-num">${isClearMode ? u.clear : u.encounter}</span>
                                                    <span class="text-xs text-slate-300 font-mono-num">/</span>
                                                    <span class="text-xs text-slate-400 font-mono-num">${u.total}</span>
                                                </div>
                                            </div>
                                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-1">
                                                <div class="${isClearMode ? 'bg-amber-400' : 'bg-indigo-400'} h-1.5 rounded-full transition-all duration-500" style="width: ${isClearMode ? u.clearRate : u.encounterRate}%"></div>
                                            </div>
                                            <div class="flex justify-end"><span class="text-[10px] font-bold text-slate-400">${isClearMode ? u.clearRate : u.encounterRate}%</span></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4"><button onclick="app.startReviewSetup()" class="relative overflow-hidden rounded-2xl p-6 text-left transition-all duration-300 group ${mistakeCount > 0 ? 'bg-gradient-to-br from-rose-500 to-orange-600 text-white hover:shadow-lg hover:shadow-rose-200' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}"><div class="relative z-10 flex justify-between items-start"><div><div class="flex items-center gap-2 mb-2"><i class="ph ph-target text-2xl"></i><span class="font-bold text-lg">弱点克服モード</span></div><p class="text-sm opacity-90">${mistakeCount > 0 ? '間違えた問題を集中的に復習します。' : '現在、苦手な問題はありません。'}</p></div><div class="font-mono-num text-3xl font-bold">${mistakeCount}</div></div></button><button onclick="app.goDictionary()" class="bg-white border border-slate-200 p-6 rounded-2xl text-left hover:border-indigo-400 hover:shadow-lg transition-all duration-300 group"><div class="flex justify-between items-start"><div><div class="flex items-center gap-2 mb-2 text-indigo-600"><i class="ph ph-books text-2xl"></i><span class="font-bold text-lg text-slate-700 group-hover:text-indigo-600">問題図鑑</span></div><p class="text-sm text-slate-500">すべての問題を閲覧、検索できます。</p></div><i class="ph ph-caret-right text-slate-300 text-2xl group-hover:text-indigo-500"></i></div></button></div>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 glass-panel p-6 rounded-2xl"><h3 class="font-bold text-slate-600 mb-4 flex items-center gap-2"><i class="ph ph-flag-checkered text-indigo-500"></i> クリア率レーダー (Clear Rate)</h3><div class="h-64"><canvas id="statsChart"></canvas></div></div>
                            <div class="glass-panel p-6 rounded-2xl flex flex-col gap-6">
                                <div><h3 class="font-bold text-slate-700 mb-4"><i class="ph ph-gear"></i> 設定</h3></div>
                                
                                <div class="space-y-4">
                                    <div class="text-xs text-slate-400 mb-2">学習データの初期化</div>
                                    <button onclick="app.resetData()" class="w-full py-2 rounded-lg border border-rose-200 text-rose-500 hover:bg-rose-50 font-bold text-sm transition-colors flex items-center justify-center gap-2"><i class="ph ph-trash"></i> データ初期化</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('mainContainer').innerHTML = html;
                const ctx = document.getElementById('statsChart').getContext('2d');
                if (app.state.chartInstance) app.state.chartInstance.destroy();
                app.state.chartInstance = new Chart(ctx, { type: 'radar', data: { labels: ['A.化学基礎', 'B.状態', 'C.反応', 'D.無機', 'E.有機', 'F.高分子'], datasets: [{ label: 'クリア率 (%)', data: radarData, backgroundColor: 'rgba(245, 158, 11, 0.2)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(245, 158, 11, 1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { stepSize: 20, display: false } } }, plugins: { legend: { display: false } } } });
            }
        };

        window.onload = app.init;

    </script>
</body>

</html>